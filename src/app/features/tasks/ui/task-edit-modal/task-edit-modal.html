<div class="task-edit-modal__header">
  <h2 mat-dialog-title>Edit Task</h2>
  <button
    mat-icon-button
    mat-dialog-close
    class="task-edit-modal__close-button"
    aria-label="Close dialog"
  >
    <mat-icon>close</mat-icon>
  </button>
</div>

<mat-dialog-content class="task-edit-modal__content">
  @if (taskStore.error()) {
    <div class="task-edit-modal__error">
      {{ taskStore.error() }}
    </div>
  }

  <form (ngSubmit)="onSubmit()" class="task-edit-modal__form">
    <mat-form-field appearance="outline" class="task-edit-modal__field">
      <mat-label>Title *</mat-label>
      <input
        matInput
        [formField]="taskForm.title"
        placeholder="Enter task title"
      />
      <mat-hint align="end">{{ taskModel().title.length }}/100</mat-hint>
      @if (taskForm.title().touched()) {
        @for (error of taskForm.title().errors(); track error.kind) {
          <mat-error>{{ error.message }}</mat-error>
        }
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="task-edit-modal__field">
      <mat-label>Description</mat-label>
      <textarea
        matInput
        [formField]="taskForm.description"
        placeholder="Enter task description"
        rows="3"
      ></textarea>
      <mat-hint align="end">{{ taskModel().description.length }}/500</mat-hint>
      @if (taskForm.description().touched()) {
        @for (error of taskForm.description().errors(); track error.kind) {
          <mat-error>{{ error.message }}</mat-error>
        }
      }
    </mat-form-field>

    <div class="task-edit-modal__row">
      <mat-form-field
        appearance="outline"
        class="task-edit-modal__field task-edit-modal__field--half"
      >
        <mat-label>Priority *</mat-label>
        <mat-select [formField]="taskForm.priority">
          @for (priority of priorities; track priority.value) {
            <mat-option [value]="priority.value">
              {{ priority.label }}
            </mat-option>
          }
        </mat-select>
        @if (taskForm.priority().touched()) {
          @for (error of taskForm.priority().errors(); track error.kind) {
            <mat-error>{{ error.message }}</mat-error>
          }
        }
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        class="task-edit-modal__field task-edit-modal__field--half"
      >
        <mat-label>Due Date *</mat-label>
        <input
          matInput
          [matDatepicker]="dueDatePicker"
          [formField]="taskForm.dueDate"
          [min]="minDate"
          placeholder="Select due date"
          readonly
        />
        <mat-datepicker-toggle
          matIconSuffix
          [for]="dueDatePicker"
        ></mat-datepicker-toggle>
        <mat-datepicker #dueDatePicker></mat-datepicker>
        @if (taskForm.dueDate().touched()) {
          @for (error of taskForm.dueDate().errors(); track error.kind) {
            <mat-error>{{ error.message }}</mat-error>
          }
        }
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="task-edit-modal__field">
      <mat-label>Estimated Time (minutes)</mat-label>
      <input
        matInput
        type="number"
        [formField]="taskForm.estimatedMinutes"
        placeholder="Enter estimated time in minutes"
      />
      <mat-hint>How long do you estimate this task will take?</mat-hint>
      @if (taskForm.estimatedMinutes().touched()) {
        @for (error of taskForm.estimatedMinutes().errors(); track error.kind) {
          <mat-error>{{ error.message }}</mat-error>
        }
      }
    </mat-form-field>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="task-edit-modal__actions">
  <button
    mat-button
    type="button"
    (click)="onCancel()"
    [disabled]="taskStore.loading() && isSubmitting()"
  >
    Cancel
  </button>
  <button
    mat-raised-button
    color="primary"
    type="submit"
    (click)="onSubmit()"
    [disabled]="(taskStore.loading() && isSubmitting()) || !taskForm().valid()"
  >
    @if (taskStore.loading() && isSubmitting()) {
      <ng-container>
        <mat-icon>hourglass_empty</mat-icon>
        Saving...
      </ng-container>
    } @else {
      Save Changes
    }
  </button>
</mat-dialog-actions>
